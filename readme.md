# 🌪️ TorDet: A Refined Two-Stage Deep Learning Approach for Radar-Based Tornado Detection

---

## 1. 简介

本仓库提供了 TorDet 算法的推理部分的接口，附带一个运行案例，适用于 CINRAD S 波段业务雷达。

论文：TGRS-2025-02627 [major revision]

## 2. 数据流与接口

**数据流：**
`.npz` 预处理文件 → 算法接口 → 输出结果

在开发和接入过程中，主要参考并修改以下两个文件：

* `debug_pipeline.py`（位于项目主目录）
* `tordet/detector.py` 中的 `TornadoDetector` 类的 `detect()` 方法

**需要补充的开发内容：**

* 按示例数据结构处理雷达基数据
* 按需求适配输出数据结构（目前仅为打印输出）

---

## 3. 环境配置

项目依赖 5 个核心包。
以下为开发及验证环境：

| 依赖项        | 开发环境    | 验证通过的新环境 |
| :------------ | :---------- | :--------------- |
| Python        | 3.10.14     | 3.13.7           |
| Torch         | 2.4.1+cu118 | 2.9.0+cu130      |
| SciPy         | 1.13.1      | 1.16.1           |
| Timm          | 0.9.7       | 1.0.20           |
| Geopy         | 2.4.1       | 2.4.1            |
| OpenCV-Python | 4.10.0.84   | 4.12.0.88        |

> ⚙️ 经验证，依赖版本升级不会影响算法运行，可根据设备情况调整。

---

## 4. 基数据预处理 `.npz` 文件指南

模型输入的 `.npz` 文件需处理为以下结构：

```python
{
    "site_id": str,
    "utc_time": datetime.datetime,
    "grid_data": {
        "elev_0": {
            "ref_data_qc": np.ndarray,  # (1152, 1152)
            "vel_data_qc": np.ndarray,  # (1152, 1152)
            "sw_data_qc": np.ndarray    # (1152, 1152)
        },
        "elev_1": {...},
        "elev_2": {...},
        "longitude": np.ndarray,  # (1152,)
        "latitude": np.ndarray    # (1152,) 从高纬到低纬，降序排列
    }
}
```

**示例参考：**
`./temp_npz/Z_RADR_I_Z9200_20240427065400_O_DOR_SAD_CAP_FMT.bin.bz2.npz`

**注意事项：**

* 基数据取 **150 km 半径内**、最低 **3 个仰角**（默认 VCP21：0.5，1.45，2.4）

* 提取变量包括：

  * 反射率因子 `ref`
  * 径向速度 `vel`
  * 速度谱宽 `sw`

* 模型输入需插值到 **250 m 空间分辨率的等距笛卡尔坐标系**
  可参考 `radar_base_data_processing/base_data_io_templete.py` 中的模板与工具函数，稍作修改即可适配。

* 缺测值处理与值域裁切

  插值前，缺测值、速度折叠区域一律填充nan

  插值后，各变量进行如下处理：

  - 反射率因子 `ref`：0 以下置零，缺测值置零
  - 径向速度 `vel`：缺测值填入 -999（模型自动处理）
  - 速度谱宽 `sw`：0 以下置零，缺测值置零

* 数据预处理过程中，其他质量控制算法（如去杂波、速度去模糊等）也可加入

---

## 5. 输出格式

每个基数据文件的输出为一个 `list[dict]` 结构，每个 dict 表示一处识别结果。

**示例输出：**

```python
[
    {
        'latitude': 23.340631131942455,
        'longitude': 113.41293231565395,
        'site': 'Z9200',
        'utc_time': '20240427065400',
        'x': 599.1183431952662,   # 插值后 1152×1152 数据中的 x 坐标
        'y': 426.3313609467456    # 插值后 1152×1152 数据中的 y 坐标（按北纬降序配列）
    }
]
```

